<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect - Book Appointment</title>
    <script src="common.js"></script>
   
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-header {
            background: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #2e7d32;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            text-decoration: none;
            color: #388e3c;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #1b5e20;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 2.8rem;
            color: #2e7d32;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .page-subtitle {
            font-size: 1.3rem;
            color: #666;
        }

        /* Main Layout */
        .booking-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2.5rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .card-title {
            font-size: 1.5rem;
            color: #2e7d32;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #4caf50;
            font-weight: 600;
        }

        /* Doctor Selection */
        .doctor-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.8rem;
            margin-bottom: 2rem;
        }

        .doctor-card {
            background: #f8fff8;
            border: 3px solid #e8f5e8;
            border-radius: 12px;
            padding: 1.8rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .doctor-card:hover {
            border-color: #4caf50;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .doctor-card.selected {
            border-color: #2e7d32;
            background: #e8f5e8;
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.15);
        }

        .doctor-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .doctor-avatar {
            width: 70px;
            height: 70px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.8rem;
            margin-right: 1.5rem;
        }

        .doctor-info h3 {
            color: #2e7d32;
            font-size: 1.4rem;
            margin-bottom: 0.3rem;
        }

        .doctor-specialty {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .doctor-rating {
            color: #ffa502;
            font-weight: 600;
            font-size: 1rem;
        }

        .doctor-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.2rem;
        }

        .view-profile-btn {
            flex: 1;
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .view-profile-btn:hover {
            background: #388e3c;
        }

        .review-doctor-btn {
            flex: 1;
            background: #ffa502;
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .review-doctor-btn:hover {
            background: #e69500;
        }

        .change-doctor-btn {
            background: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #4caf50;
            padding: 0.9rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }

        .change-doctor-btn:hover {
            background: #4caf50;
            color: white;
        }

        /* Date Selection */
        .date-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .calendar-container, .timeslots-container {
            background: #f8fff8;
            border-radius: 12px;
            padding: 1.8rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .month-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2e7d32;
        }

        .nav-btn {
            background: #e8f5e8;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            color: #2e7d32;
            font-weight: bold;
            font-size: 1.2rem;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #4caf50;
            color: white;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.6rem;
        }

        .calendar-day {
            text-align: center;
            padding: 1rem 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: #e8f5e8;
        }

        .calendar-day.selected {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.unavailable {
            color: #ccc;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 0.8rem 0;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        /* Time Slots */
        .timeslots-header {
            margin-bottom: 1.5rem;
        }

        .timeslots-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 0.5rem;
        }

        .timeslots-date {
            color: #666;
            font-size: 1rem;
        }

        .timeslots-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            max-height: 350px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .time-slot {
            padding: 1.2rem 0.5rem;
            text-align: center;
            background: white;
            border: 2px solid #e8f5e8;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-slot:hover {
            border-color: #4caf50;
            background: #f8fff8;
        }

        .time-slot.selected {
            background: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }

        .time-slot.unavailable {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* Doctor Profile */
        .doctor-profile {
            background: #f8fff8;
            border-radius: 12px;
            padding: 2.2rem;
            border-left: 5px solid #4caf50;
            transition: all 0.3s ease;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: #4caf50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 2.5rem;
            margin-right: 2rem;
        }

        .profile-info h2 {
            color: #2e7d32;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .profile-specialty {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .profile-rating {
            color: #ffa502;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .profile-description {
            color: #555;
            line-height: 1.7;
            margin-bottom: 1.8rem;
            font-size: 1.05rem;
        }

        .experience-section {
            background: white;
            padding: 1.8rem;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
        }

        .experience-section h4 {
            color: #2e7d32;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .experience-section p {
            color: #555;
            line-height: 1.7;
        }

        /* Booking Summary */
        .booking-summary {
            position: sticky;
            top: 2rem;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 2.2rem;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .summary-title {
            font-size: 1.5rem;
            color: #2e7d32;
            margin-bottom: 1.8rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid #4caf50;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.2rem;
            padding-bottom: 1.2rem;
            border-bottom: 1px solid #e8f5e8;
        }

        .summary-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-label {
            color: #666;
            font-weight: 500;
        }

        .summary-value {
            color: #2e7d32;
            font-weight: 600;
            text-align: right;
            max-width: 200px;
        }

        /* Comment Section in Summary */
        .comment-section {
            margin: 1.8rem 0;
            padding: 1.5rem 0;
            border-top: 1px solid #e8f5e8;
            border-bottom: 1px solid #e8f5e8;
        }

        .comment-label {
            color: #2e7d32;
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: block;
            font-size: 1.1rem;
        }

        .comment-textarea {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid #e8f5e8;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: all 0.3s ease;
            background: #f8fff8;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background: white;
        }

        .comment-textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        .comment-preview {
            background: #f8fff8;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #4caf50;
            margin-top: 1rem;
            font-size: 0.95rem;
            color: #555;
            display: none;
        }

        .comment-preview.show {
            display: block;
        }

        .comment-preview .preview-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .comment-preview .preview-text {
            color: #2e7d32;
            font-style: italic;
        }

        .book-appointment-btn {
            background: #2e7d32;
            color: white;
            border: none;
            padding: 1.5rem 2.5rem;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1.5rem;
        }

        .book-appointment-btn:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .book-appointment-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .confirmation-note {
            text-align: center;
            color: #666;
            font-size: 0.95rem;
            margin-top: 1rem;
            padding: 0 1rem;
        }

        /* Doctor Profile Highlight */
        .doctor-profile.highlighted {
            animation: pulse-highlight 2s ease-in-out;
            border: 2px solid #2e7d32;
        }

        @keyframes pulse-highlight {
            0% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 125, 50, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0); }
        }

        /* Review Section */
        .review-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            border-left: 5px solid #ffa502;
        }

        .review-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .review-rating {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .star-rating {
            display: flex;
            gap: 0.5rem;
        }

        .star {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s;
        }

        .star:hover,
        .star.selected {
            color: #ffa502;
        }

        .review-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e8f5e8;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
        }

        .review-textarea:focus {
            outline: none;
            border-color: #4caf50;
        }

        .submit-review-btn {
            background: #ffa502;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-review-btn:hover {
            background: #e69500;
        }

        /* Responsive */
        @media (max-width: 1100px) {
            .booking-layout {
                grid-template-columns: 1fr;
            }
            
            .booking-summary {
                position: static;
            }
        }

        @media (max-width: 900px) {
            .date-selection {
                grid-template-columns: 1fr;
            }
            
            .doctor-selection {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-links {
                gap: 1rem;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .page-title {
                font-size: 2.2rem;
            }
            
            .timeslots-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 1.5rem;
            }
            
            .doctor-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .timeslots-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">CareConnect</div>
            <nav>
                <ul class="nav-links">
                    <li><a href="MedicalDashboard.html">Dashboard</a></li>
                    <li><a href="#" style="color: #1b5e20; font-weight: 600;">Appointments</a></li>
                    <li><a href="StudentProfile.html">Student Profile</a></li>
                    <li><a href="EmergencyRequest.html">Emergency</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <div class="user-avatar">AM</div>
                <span>Loading...</span>
                <button onclick="logout()" style="margin-left: 1rem; padding: 0.5rem 1rem; background: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">Appointment Booking</h1>
            <p class="page-subtitle">Doctor's Availability & Scheduling System</p>
        </div>

        <div class="booking-layout">
            <!-- Left Column - Booking Interface -->
            <main class="booking-main">
                <!-- Doctor Selection -->
                <div class="card">
                    <h2 class="card-title">Select Your Doctor</h2>
                    <div class="doctor-selection">
                        <!-- Doctors will be loaded dynamically from the API -->
                        <div style="padding: 20px; text-align: center; color: #666;">Loading doctors...</div>
                    </div>
                    <button class="change-doctor-btn" onclick="showMoreDoctors()" style="display: none;">Change Doctor / View More Doctors</button>
                </div>

                <!-- Date & Time Selection -->
                <div class="card">
                    <h2 class="card-title">Select Date & Time</h2>
                    <div class="date-selection">
                        <!-- Calendar -->
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="month-title" id="monthTitle">October 2024</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="nav-btn" onclick="changeMonth(-1)">‹</button>
                                    <button class="nav-btn" onclick="changeMonth(1)">›</button>
                                </div>
                            </div>
                            <div class="calendar" id="calendar">
                                <!-- Calendar will be generated dynamically -->
                            </div>
                        </div>

                        <!-- Time Slots -->
                        <div class="timeslots-container">
                            <div class="timeslots-header">
                                <div class="timeslots-title">Available Time Slots</div>
                                <div class="timeslots-date" id="selectedDateDisplay">October 8, 2024</div>
                            </div>
                            <div class="timeslots-grid" id="timeslotsGrid">
                                <!-- Time slots will be generated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Doctor Profile -->
                <div class="card">
                    <h2 class="card-title">Doctor Profile</h2>
                    <div class="doctor-profile" id="doctorProfile">
                        <!-- Doctor profile will be updated dynamically -->
                    </div>
                </div>

                <!-- Review Section -->
                <div class="card">
                    <h2 class="card-title">Review Your Doctor</h2>
                    <div class="review-section">
                        <p style="color: #666; margin-bottom: 1.5rem;">Share your experience to help other patients</p>
                        <div class="review-form" id="reviewForm">
                            <div class="review-rating">
                                <span style="font-weight: 600;">Rating:</span>
                                <div class="star-rating">
                                    <span class="star" data-rating="1">★</span>
                                    <span class="star" data-rating="2">★</span>
                                    <span class="star" data-rating="3">★</span>
                                    <span class="star" data-rating="4">★</span>
                                    <span class="star" data-rating="5">★</span>
                                </div>
                                <span id="ratingValue" style="font-weight: 600; color: #ffa502;">0/5</span>
                            </div>
                            <textarea 
                                class="review-textarea" 
                                placeholder="Share your experience with the doctor. What did you like? How was the service?" 
                                id="reviewText">
                            </textarea>
                            <button class="submit-review-btn" onclick="submitReview()">Submit Review</button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Right Column - Booking Summary -->
            <aside class="booking-summary">
                <div class="summary-card">
                    <h2 class="summary-title">Appointment Summary</h2>
                    
                    <div class="summary-item">
                        <span class="summary-label">Doctor:</span>
                        <span class="summary-value" id="summaryDoctor">Dr. Sarah Chen</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Specialty:</span>
                        <span class="summary-value" id="summarySpecialty">General Practitioner</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Date:</span>
                        <span class="summary-value" id="summaryDate">October 8, 2024</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Time:</span>
                        <span class="summary-value" id="summaryTime">03:00 PM</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Duration:</span>
                        <span class="summary-value">30 minutes</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Location:</span>
                        <span class="summary-value">Campus Health Center, Room 204</span>
                    </div>
                    
                    <div class="summary-item">
                        <span class="summary-label">Appointment Type:</span>
                        <span class="summary-value">General Consultation</span>
                    </div>

                    <!-- Comment Section -->
                    <div class="comment-section">
                        <label for="appointmentComment" class="comment-label">Reason for Appointment</label>
                        <textarea 
                            id="appointmentComment" 
                            class="comment-textarea" 
                            placeholder="Please specify the reason for your appointment. Be as detailed as possible to help the doctor prepare. Examples:
• Annual physical check-up
• Follow-up for previous condition
• New symptoms or concerns
• Prescription refill
• Vaccination or immunization"
                            rows="4"
                            maxlength="500"
                        ></textarea>
                        <div class="character-count" style="text-align: right; font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                            <span id="charCount">0</span>/500 characters
                        </div>
                        <div id="commentPreview" class="comment-preview">
                            <div class="preview-label">Comment Preview:</div>
                            <div class="preview-text" id="previewText">No comment provided</div>
                        </div>
                    </div>

                    <button class="book-appointment-btn" onclick="bookAppointment()">
                        Confirm Appointment
                    </button>

                    <p class="confirmation-note">
                        You will receive a confirmation email and SMS reminder 24 hours before your appointment.
                    </p>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // Calendar variables
        let currentDate = new Date(2025, 12, 8); // December 8 2025 (month is 0-indexed)
        let selectedDate = new Date(2025, 12, 10); // December 10 2025
        let selectedTime = "03:00 PM";
        let selectedDoctorId = null; // Will be set when doctors are loaded
        let appointmentComment = "";

        // Doctor data - will be loaded from API
        let doctors = {};
        let doctorsArray = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load doctors first
            await loadDoctors();

            initializeCalendar();
            updateTimeSlots();
            if (doctorsArray.length > 0) {
                // Select the first doctor by default
                const firstDoctor = doctorsArray[0];
                selectedDoctorId = firstDoctor.id;
                updateDoctorProfile(firstDoctor);
            }
            updateSummary();
            initializeStarRating();
            initializeCommentSection();
        });

        // Load doctors from API
        async function loadDoctors() {
            try {
                const response = await fetch('http://localhost:8000/doctors');

                if (!response.ok) {
                    throw new Error('Failed to load doctors');
                }

                doctorsArray = await response.json();
                console.log('Loaded doctors:', doctorsArray);

                // Convert array to object for backward compatibility
                doctorsArray.forEach((doctor, index) => {
                    const key = doctor.name.toLowerCase().split(' ')[1] || `doctor${index}`;
                    doctors[key] = {
                        id: doctor.id,
                        name: doctor.name,
                        avatar: doctor.avatar || doctor.name.substring(0, 2).toUpperCase(),
                        specialty: doctor.specialty || 'General Practitioner',
                        rating: `★ ${doctor.rating.toFixed(1)} (${doctor.reviews} reviews)`,
                        description: `${doctor.name} is a dedicated ${doctor.specialty} with extensive experience in providing quality healthcare.`,
                        experience: `Professional healthcare provider specializing in ${doctor.specialty}.`,
                        color: getRandomColor(),
                        email: doctor.email,
                        phone: doctor.phone
                    };
                });

                // Render doctor cards
                renderDoctorCards();

            } catch (error) {
                console.error('Error loading doctors:', error);
                // Show error message
                const doctorSelection = document.querySelector('.doctor-selection');
                if (doctorSelection) {
                    doctorSelection.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Failed to load doctors. Please refresh the page.</div>';
                }
            }
        }

        // Render doctor cards dynamically
        function renderDoctorCards() {
            const doctorSelection = document.querySelector('.doctor-selection');
            if (!doctorSelection) return;

            doctorSelection.innerHTML = '';

            doctorsArray.forEach((doctor, index) => {
                const doctorCard = document.createElement('div');
                doctorCard.className = 'doctor-card';
                if (index === 0) doctorCard.classList.add('selected'); // Select first doctor by default
                doctorCard.setAttribute('data-doctor-id', doctor.id);

                const avatar = doctor.avatar || doctor.name.substring(0, 2).toUpperCase();
                const rating = doctor.rating > 0 ? `★ ${doctor.rating.toFixed(1)} (${doctor.reviews} reviews)` : '★ New';

                doctorCard.innerHTML = `
                    <div class="doctor-header">
                        <div class="doctor-avatar">${avatar}</div>
                        <div class="doctor-info">
                            <h3>${doctor.name}</h3>
                            <p class="doctor-specialty">${doctor.specialty}</p>
                            <div class="doctor-rating">${rating}</div>
                        </div>
                    </div>
                    <div class="doctor-actions">
                        <button class="view-profile-btn" onclick="viewDoctorProfileById(${doctor.id})">View Profile</button>
                        <button class="review-doctor-btn" onclick="reviewDoctor('${doctor.name}')">Review Doctor</button>
                    </div>
                `;

                // Add click event to select doctor
                doctorCard.addEventListener('click', function() {
                    document.querySelectorAll('.doctor-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedDoctorId = doctor.id;
                    updateDoctorProfile(doctor);
                    updateTimeSlots();
                });

                doctorSelection.appendChild(doctorCard);
            });
        }

        // Helper function to get random color
        function getRandomColor() {
            const colors = ['#4caf50', '#2196f3', '#ff9800', '#9c27b0', '#f44336', '#00bcd4'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // New function to view doctor profile by ID
        function viewDoctorProfileById(doctorId) {
            const doctor = doctorsArray.find(d => d.id === doctorId);
            if (doctor) {
                // Select the doctor card
                document.querySelectorAll('.doctor-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`.doctor-card[data-doctor-id="${doctorId}"]`).classList.add('selected');

                selectedDoctorId = doctorId;
                updateDoctorProfile(doctor);

                // Scroll to profile
                document.getElementById('doctorProfile').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // Highlight profile
                highlightDoctorProfile();
            }
        }

        // Calendar Functions
        function initializeCalendar() {
            const monthTitle = document.getElementById('monthTitle');
            const calendar = document.getElementById('calendar');
            
            // Update month title
            monthTitle.textContent = getMonthYearString(currentDate);
            
            // Clear calendar
            calendar.innerHTML = '';
            
            // Add day headers
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Get first day of month and total days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const totalDays = lastDay.getDate();
            const firstDayIndex = (firstDay.getDay() + 6) % 7; // Adjust so Monday is 0
            
            // Add days from previous month
            const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
            for (let i = firstDayIndex - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevMonthLastDay - i;
                calendar.appendChild(day);
            }
            
            // Add days of current month
            const today = new Date();
            for (let i = 1; i <= totalDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = i;
                
                // Check if this day is today
                const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                if (dayDate.toDateString() === today.toDateString()) {
                    day.style.borderColor = '#4caf50';
                    day.style.borderWidth = '2px';
                }
                
                // Check if this day is selected
                if (dayDate.toDateString() === selectedDate.toDateString()) {
                    day.classList.add('selected');
                }
                
                // Add click event
                day.addEventListener('click', function() {
                    selectDate(i);
                });
                
                // Mark some days as unavailable (for demo)
                if (Math.random() < 0.2) { // 20% chance of being unavailable
                    day.classList.add('unavailable');
                }
                
                calendar.appendChild(day);
            }
            
            // Add days from next month
            const totalCells = 42; // 6 rows * 7 days
            const remainingCells = totalCells - (firstDayIndex + totalDays);
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendar.appendChild(day);
            }
            
            // Update selected date display
            document.getElementById('selectedDateDisplay').textContent = formatDate(selectedDate);
            document.getElementById('summaryDate').textContent = formatDate(selectedDate);
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            initializeCalendar();
            updateTimeSlots();
        }

        function selectDate(day) {
            const dayElement = event.target;
            if (dayElement.classList.contains('unavailable') || dayElement.classList.contains('other-month')) {
                return;
            }
            
            // Update selected date
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            
            // Update UI
            document.querySelectorAll('.calendar-day').forEach(d => {
                d.classList.remove('selected');
            });
            dayElement.classList.add('selected');
            
            // Update displays
            document.getElementById('selectedDateDisplay').textContent = formatDate(selectedDate);
            document.getElementById('summaryDate').textContent = formatDate(selectedDate);
            
            // Update time slots
            updateTimeSlots();
        }

        async function updateTimeSlots() {
            console.log('=== updateTimeSlots START ===');
            console.log('selectedDoctorId:', selectedDoctorId);
            console.log('selectedDate:', selectedDate);

            const timeslotsGrid = document.getElementById('timeslotsGrid');

            // Only try to fetch from API if we have a doctor and date selected
            if (!selectedDoctorId || !selectedDate) {
                console.log('Condition not met - doctor or date missing');
                timeslotsGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Please select a doctor and date to see available time slots.</div>';
                return;
            }

            try {
                timeslotsGrid.innerHTML = '<div style="padding: 20px; text-align: center;">Loading available time slots...</div>';

                // Format date to YYYY-MM-DD for API
                const formattedDate = selectedDate.toISOString().split('T')[0];
                console.log('Formatted date:', formattedDate);

                // Fetch available slots from API
                const slotsData = await getAvailableSlots(selectedDoctorId, formattedDate);
                console.log('API call completed. Received slots data:', slotsData);

                // Check if doctor is not available on this day
                if (slotsData.message) {
                    timeslotsGrid.innerHTML = `<div style="padding: 20px; text-align: center; color: #ff9800;">${slotsData.message}</div>`;
                    return;
                }

                // Get available slots from API (these are already filtered for doctor's working hours)
                const availableSlots = slotsData.available_slots || [];
                const bookedSlots = slotsData.booked_slots || [];

                // Combine available and booked slots to show full schedule
                const allSlots = [...new Set([...availableSlots, ...bookedSlots])].sort();

                console.log('Available slots:', availableSlots.length);
                console.log('Booked slots:', bookedSlots.length);
                console.log('Total slots:', allSlots.length);

                // Clear and rebuild the time slots grid
                timeslotsGrid.innerHTML = '';

                if (allSlots.length === 0) {
                    timeslotsGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Doctor has no availability set for this day. Please select another date.</div>';
                    return;
                }

                allSlots.forEach(time => {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.textContent = time;

                    // Check if this slot is booked (unavailable)
                    if (bookedSlots.includes(time)) {
                        slot.classList.add('unavailable');
                    }

                    // Check if this is the selected time
                    if (time === selectedTime) {
                        slot.classList.add('selected');
                    }

                    // Add click event for available slots only
                    if (availableSlots.includes(time)) {
                        slot.addEventListener('click', function() {
                            selectTime(time);
                        });
                    }

                    timeslotsGrid.appendChild(slot);
                });

                // Show message if all slots are booked
                if (availableSlots.length === 0 && bookedSlots.length > 0) {
                    timeslotsGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">All time slots are booked for this date. Please select another date.</div>';
                }

                // Show working hours info
                if (slotsData.working_hours) {
                    const infoDiv = document.createElement('div');
                    infoDiv.style.cssText = 'padding: 10px; text-align: center; color: #666; font-size: 0.9rem; background: #f8f9fa; border-radius: 5px; margin-top: 10px;';
                    infoDiv.textContent = `Working hours: ${slotsData.working_hours} | Slot duration: ${slotsData.slot_duration} minutes`;
                    timeslotsGrid.parentElement.appendChild(infoDiv);
                }

                console.log('Slots rendered successfully');

            } catch (error) {
                console.error('!!! CAUGHT ERROR in API call:', error);
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                timeslotsGrid.innerHTML = '<div style="padding: 20px; text-align: center; color: #dc3545;">Error loading time slots. Please try again or select a different date.</div>';
            }

            console.log('=== updateTimeSlots END ===');
        }

        function selectTime(time) {
            selectedTime = time;
            
            // Update UI
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Update summary
            document.getElementById('summaryTime').textContent = time;
        }

        // Doctor Selection Functions
        function viewDoctorProfile(doctorId) {
            // Select the doctor card
            document.querySelectorAll('.doctor-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.doctor-card[data-doctor="${doctorId}"]`).classList.add('selected');
            
            // Update doctor profile
            updateDoctorProfile(doctorId);
            
            // Scroll to profile
            document.getElementById('doctorProfile').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
            
            // Highlight profile
            highlightDoctorProfile();
        }

        function updateDoctorProfile(doctor) {
            // Handle both old format (string key) and new format (doctor object)
            if (typeof doctor === 'string') {
                doctor = doctors[doctor];
            }

            if (!doctor) return;

            selectedDoctorId = doctor.id;
            const avatar = doctor.avatar || doctor.name.substring(0, 2).toUpperCase();
            const color = doctor.color || getRandomColor();
            const description = doctor.description || `${doctor.name} is a dedicated ${doctor.specialty} with extensive experience in providing quality healthcare.`;
            const experience = doctor.experience || `Professional healthcare provider specializing in ${doctor.specialty}.`;
            const rating = doctor.rating ? (typeof doctor.rating === 'string' ? doctor.rating : `★ ${doctor.rating.toFixed(1)} (${doctor.reviews} reviews)`) : '★ New';

            const profileHTML = `
                <div class="profile-header">
                    <div class="profile-avatar" style="background: ${color}">${avatar}</div>
                    <div class="profile-info">
                        <h2>${doctor.name}</h2>
                        <p class="profile-specialty">${doctor.specialty}</p>
                        <div class="profile-rating">${rating}</div>
                    </div>
                </div>

                <p class="profile-description">${description}</p>

                <div class="experience-section">
                    <h4>Professional Experience</h4>
                    <p>${experience}</p>
                </div>
            `;

            document.getElementById('doctorProfile').innerHTML = profileHTML;

            // Update summary
            document.getElementById('summaryDoctor').textContent = doctor.name;
            document.getElementById('summarySpecialty').textContent = doctor.specialty.split(',')[0];

            // Update time slots when doctor changes
            updateTimeSlots();
        }

        function highlightDoctorProfile() {
            const profileSection = document.getElementById('doctorProfile');
            profileSection.classList.add('highlighted');
            
            setTimeout(() => {
                profileSection.classList.remove('highlighted');
            }, 2000);
        }

        function reviewDoctor(doctorName) {
            alert(`Reviewing Dr. ${doctorName}\n\nIn a complete implementation, this would open:\n1. A detailed review form\n2. Previous patient reviews\n3. Rating breakdown\n4. Doctor response history\n\nFor now, you can use the review section below to submit your review.`);
            
            // Scroll to review section
            document.querySelector('.review-section').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        function showMoreDoctors() {
            alert('Opening doctor directory...\n\nAvailable doctors:\n• Dr. Michael Brown (Cardiologist)\n• Dr. Lisa Wang (Dermatologist)\n• Dr. James Wilson (Orthopedist)\n• Dr. Maria Garcia (Psychiatrist)\n\nYou can filter by specialty, availability, and ratings.');
        }

        // Comment Section Functions
        function initializeCommentSection() {
            const commentTextarea = document.getElementById('appointmentComment');
            const charCount = document.getElementById('charCount');
            const commentPreview = document.getElementById('commentPreview');
            const previewText = document.getElementById('previewText');
            
            // Update character count
            commentTextarea.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                
                // Update preview
                if (length > 0) {
                    previewText.textContent = this.value;
                    commentPreview.classList.add('show');
                } else {
                    previewText.textContent = "No comment provided";
                    commentPreview.classList.remove('show');
                }
                
                // Update appointment comment variable
                appointmentComment = this.value;
            });
            
            // Add input event to save comment
            commentTextarea.addEventListener('blur', function() {
                appointmentComment = this.value;
            });
        }

        // Review Functions
        function initializeStarRating() {
            const stars = document.querySelectorAll('.star');
            let selectedRating = 0;
            
            stars.forEach(star => {
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(rating);
                });
                
                star.addEventListener('mouseout', function() {
                    highlightStars(selectedRating);
                });
                
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('ratingValue').textContent = `${selectedRating}/5`;
                    highlightStars(selectedRating);
                });
            });
            
            function highlightStars(rating) {
                stars.forEach(star => {
                    const starRating = parseInt(star.getAttribute('data-rating'));
                    if (starRating <= rating) {
                        star.classList.add('selected');
                    } else {
                        star.classList.remove('selected');
                    }
                });
            }
        }

        function submitReview() {
            const rating = document.querySelectorAll('.star.selected').length;
            const reviewText = document.getElementById('reviewText').value.trim();
            const doctorName = doctors[selectedDoctor].name;
            
            if (rating === 0) {
                alert('Please select a rating before submitting your review.');
                return;
            }
            
            if (!reviewText) {
                alert('Please write your review before submitting.');
                return;
            }
            
            // In a real app, this would send to a backend API
            alert(`Thank you for your review!\n\nDoctor: ${doctorName}\nRating: ${rating}/5\n\nYour review has been submitted and will be visible to other patients after moderation.`);
            
            // Reset form
            document.querySelectorAll('.star').forEach(star => star.classList.remove('selected'));
            document.getElementById('ratingValue').textContent = '0/5';
            document.getElementById('reviewText').value = '';
        }

        // Booking Functions
        async function bookAppointment() {
            const doctor = document.getElementById('summaryDoctor').textContent;
            const date = document.getElementById('summaryDate').textContent;
            const time = document.getElementById('summaryTime').textContent;
            const comment = document.getElementById('appointmentComment').value.trim();

            // Validate selections
            if (!selectedDoctorId) {
                alert('❌ Please select a doctor');
                return;
            }

            if (!selectedDate) {
                alert('❌ Please select a date');
                return;
            }

            if (!selectedTime) {
                alert('❌ Please select a time');
                return;
            }

            let confirmationMessage = `Confirm Appointment Details:\n\nDoctor: ${doctor}\nDate: ${date}\nTime: ${time}\n\nLocation: Campus Health Center, Room 204`;

            // Add comment to confirmation if provided
            if (comment) {
                confirmationMessage += `\n\nReason for Appointment:\n"${comment.substring(0, 200)}${comment.length > 200 ? '...' : ''}"`;
            } else {
                confirmationMessage += `\n\nReason for Appointment: Not specified`;
            }

            confirmationMessage += `\n\nClick OK to confirm.`;

            const confirmAppointment = confirm(confirmationMessage);

            if (confirmAppointment) {
                try {
                    // Format date to YYYY-MM-DD for API
                    const formattedDate = formatDateForAPI(selectedDate);

                    // Call the backend API to create appointment
                    const appointmentData = {
                        doctor_id: selectedDoctorId,
                        appointment_date: formattedDate,
                        appointment_time: selectedTime,
                        type: "General Consultation",
                        notes: comment || ""
                    };

                    console.log('Booking appointment with data:', appointmentData);
                    const result = await createAppointment(appointmentData);
                    console.log('Appointment created:', result);

                    if (result) {
                        let successMessage = `✅ Appointment Confirmed!\n\nYou have successfully booked an appointment with ${doctor} on ${date} at ${time}.\n\n`;

                        if (comment) {
                            successMessage += `Your reason for appointment has been noted:\n"${comment.substring(0, 150)}${comment.length > 150 ? '...' : ''}"\n\n`;
                        }

                        successMessage += `A confirmation email has been sent to your registered email address.\n\nYou will receive a reminder 24 hours before your appointment.`;

                        alert(successMessage);

                        // Reset form for next booking
                        resetBookingForm();
                    } else {
                        alert('❌ Failed to book appointment. Please try again.');
                    }
                } catch (error) {
                    console.error('Error booking appointment:', error);
                    alert(`❌ Error booking appointment: ${error.message || 'Please try again'}`);
                }
            }
        }

        <!-- Add this to AppointmentBooking.html - Replace the rescheduleAppointment function -->

        
        async function rescheduleAppointment(appointmentId) {
            try {
                // First, get appointment details to check 12-hour rule
                const response = await fetch(`${API_URL}/appointments`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                
                if (!response.ok) {
                    alert('❌ Failed to load appointment details');
                    return;
                }
                
                const appointments = await response.json();
                const appointment = appointments.find(a => a.id === appointmentId);
                
                if (!appointment) {
                    alert('❌ Appointment not found');
                    return;
                }
                
                // Check if can reschedule (12-hour rule)
                if (!appointment.can_reschedule) {
                    alert(`⚠️ Cannot Reschedule\n\nYou can only reschedule appointments that are more than 12 hours away.\n\nThis appointment is scheduled for:\n${appointment.date} at ${appointment.time}\n\nPlease contact the health center directly for urgent changes:\n📞 Phone: 0535-86-0104`);
                    return;
                }
                
                // Show reschedule dialog
                const newDate = prompt(`Reschedule Appointment\n\nCurrent appointment:\n${appointment.date} at ${appointment.time}\nDoctor: ${appointment.doctor_name}\n\nEnter new date (YYYY-MM-DD):`);
                
                if (!newDate) return; // User cancelled
                
                const newTime = prompt(`Enter new time (HH:MM AM/PM):\n\nExample: 10:00 AM`);
                
                if (!newTime) return; // User cancelled
                
                // Update appointment
                const updateResponse = await fetch(`${API_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appointment_date: newDate,
                        appointment_time: newTime
                    })
                });
                
                if (updateResponse.ok) {
                    alert(`✅ Appointment Rescheduled!\n\nNew date: ${newDate}\nNew time: ${newTime}\n\nYou will receive a confirmation email.`);
                    location.reload(); // Refresh to show updated appointment
                } else {
                    const error = await updateResponse.json();
                    alert(`❌ Failed to reschedule: ${error.detail || 'Unknown error'}`);
                }
                
            } catch (error) {
                console.error('Error rescheduling appointment:', error);
                alert('❌ Network error. Please try again.');
            }
        }

        // Add this function to cancel appointment
        async function cancelAppointment(appointmentId) {
            const confirmCancel = confirm('Are you sure you want to cancel this appointment?\n\nThis action cannot be undone.');
            
            if (!confirmCancel) return;
            
            try {
                const response = await fetch(`${API_URL}/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    alert('✅ Appointment cancelled successfully');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`❌ Failed to cancel: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('❌ Network error. Please try again.');
            }
        }

        function resetBookingForm() {
            // Reset comment section
            document.getElementById('appointmentComment').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('commentPreview').classList.remove('show');
            document.getElementById('previewText').textContent = 'No comment provided';
            appointmentComment = '';
            
            // Reset review section
            document.querySelectorAll('.star').forEach(star => star.classList.remove('selected'));
            document.getElementById('ratingValue').textContent = '0/5';
            document.getElementById('reviewText').value = '';
            
            // Show success message
            setTimeout(() => {
                alert('✅ Your appointment has been scheduled successfully!\n\nYou can view your upcoming appointments in the Dashboard.\n\nWould you like to book another appointment?');
            }, 500);
        }

        function updateSummary() {
            // Already handled by individual update functions
        }

        // Helper Functions
        function getMonthYearString(date) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function formatDate(date) {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function formatDateForAPI(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Logout function from common.js
        function logout() {
            sessionStorage.clear();
            window.location.href = 'Login.html';
        }

        // Initialize user info
        window.addEventListener('load', function() {
            const userNameElement = document.querySelector('.user-info span');
            const userAvatarElement = document.querySelector('.user-avatar');
            
            // Try to get user info from sessionStorage
            const username = sessionStorage.getItem('username');
            const fullName = sessionStorage.getItem('fullName');
            
            if (userNameElement) {
                userNameElement.textContent = fullName || username || 'Alexandra Miller';
            }
            
            if (userAvatarElement) {
                const initials = fullName 
                    ? fullName.split(' ').map(n => n[0]).join('').toUpperCase()
                    : (username ? username.substring(0, 2).toUpperCase() : 'AM');
                userAvatarElement.textContent = initials;
            }
        });
    </script>

        
    <script>
    const API_URL = 'http://localhost:8000';
    // Le code du widget est dans ChatbotWidget.html
    </script>

    <!-- CHATBOT - Add before </body> in ALL pages -->
    <style>
        #chatbot-widget{position:fixed;bottom:20px;right:20px;z-index:1000;font-family:'Segoe UI',Arial,sans-serif}#chat-button{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#2e7d32 0%,#4caf50 100%);border:none;cursor:pointer;box-shadow:0 4px 20px rgba(46,125,50,0.4);display:flex;align-items:center;justify-content:center;transition:all .3s ease}#chat-button:hover{transform:scale(1.1)}#chat-button svg{width:30px;height:30px;fill:white}#chat-window{display:none;position:fixed;bottom:90px;right:20px;width:380px;height:550px;background:white;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2);flex-direction:column;overflow:hidden}#chat-window.open{display:flex}.chat-header{background:linear-gradient(135deg,#2e7d32 0%,#4caf50 100%);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center}.chat-header h3{margin:0;font-size:1.3rem}.chat-header p{margin:5px 0 0 0;opacity:0.9;font-size:0.9rem}#close-chat{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer}#chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f8fff8}.message{margin-bottom:15px;display:flex;flex-direction:column}.message.user{align-items:flex-end}.message.bot{align-items:flex-start}.message-content{max-width:80%;padding:12px 16px;border-radius:12px;word-wrap:break-word}.message.user .message-content{background:#2e7d32;color:white}.message.bot .message-content{background:white;color:#333;border:1px solid #e8f5e8}.message-time{font-size:0.75rem;color:#999;margin-top:5px}.chat-input-container{padding:15px;background:white;border-top:1px solid #e8f5e8;display:flex;gap:10px}#chat-input{flex:1;padding:12px 15px;border:2px solid #e8f5e8;border-radius:25px;font-size:0.95rem;outline:none}#chat-input:focus{border-color:#4caf50}#send-button{background:#4caf50;color:white;border:none;width:45px;height:45px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}#send-button:hover{background:#388e3c}.quick-actions{padding:10px 20px;background:white;border-top:1px solid #e8f5e8;display:flex;gap:8px;flex-wrap:wrap}.quick-action-btn{padding:8px 12px;background:#e8f5e8;color:#2e7d32;border:none;border-radius:15px;font-size:0.85rem;cursor:pointer}.quick-action-btn:hover{background:#4caf50;color:white}
    </style>

    <div id="chatbot-widget">
        <button id="chat-button"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg></button>
        <div id="chat-window">
            <div class="chat-header"><div><h3>CareConnect Assistant</h3><p>Ask me anything</p></div><button id="close-chat">×</button></div>
            <div class="quick-actions">
                <button class="quick-action-btn" data-msg="Book an appointment">📅 Appointment</button>
                <button class="quick-action-btn" data-msg="I need emergency help">🚨 Emergency</button>
            </div>
            <div id="chat-messages">
                <div class="message bot"><div class="message-content">Hello! How can I help you today?</div></div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type your message..." />
                <button id="send-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
    let conversationId=null,userContext=null;const chatButton=document.getElementById('chat-button'),chatWindow=document.getElementById('chat-window'),closeChat=document.getElementById('close-chat'),chatMessages=document.getElementById('chat-messages'),chatInput=document.getElementById('chat-input'),sendButton=document.getElementById('send-button');chatButton.addEventListener('click',()=>{chatWindow.classList.toggle('open');chatWindow.classList.contains('open')&&chatInput.focus()});closeChat.addEventListener('click',()=>chatWindow.classList.remove('open'));async function sendMessage(msg){if(!msg.trim())return;addMessage(msg,'user');chatInput.value='';sendButton.disabled=true;showTypingIndicator();try{const res=await fetch(`${API_URL}/chat/`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,conversation_id:conversationId,user_context:userContext})});const data=await res.json();hideTypingIndicator();conversationId=data.conversation_id;addMessage(data.reply,'bot')}catch(e){hideTypingIndicator();addMessage('Sorry, error occurred.',  'bot');console.error(e)}finally{sendButton.disabled=false}}function addMessage(text,type){const msgDiv=document.createElement('div');msgDiv.className=`message ${type}`;const contentDiv=document.createElement('div');contentDiv.className='message-content';contentDiv.textContent=text;const timeDiv=document.createElement('div');timeDiv.className='message-time';timeDiv.textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});msgDiv.appendChild(contentDiv);msgDiv.appendChild(timeDiv);chatMessages.appendChild(msgDiv);chatMessages.scrollTop=chatMessages.scrollHeight}function showTypingIndicator(){const indicator=document.createElement('div');indicator.className='message bot';indicator.id='typing-indicator';indicator.innerHTML='<div style="padding:12px;background:white;border:1px solid #e8f5e8;border-radius:12px"><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;margin-right:4px;animation:typing 1.4s infinite"></span><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;margin-right:4px;animation:typing 1.4s infinite 0.2s"></span><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;animation:typing 1.4s infinite 0.4s"></span></div>';chatMessages.appendChild(indicator);chatMessages.scrollTop=chatMessages.scrollHeight}function hideTypingIndicator(){const indicator=document.getElementById('typing-indicator');indicator&&indicator.remove()}sendButton.addEventListener('click',()=>sendMessage(chatInput.value));chatInput.addEventListener('keypress',e=>{e.key==='Enter'&&sendMessage(chatInput.value)});document.querySelectorAll('.quick-action-btn').forEach(btn=>btn.addEventListener('click',()=>sendMessage(btn.dataset.msg)));function loadUserContext(){const username=sessionStorage.getItem('username'),fullName=sessionStorage.getItem('fullName'),studentId=sessionStorage.getItem('studentId');username&&(userContext={name:fullName||username,student_id:studentId||'N/A'})}loadUserContext();const style=document.createElement('style');style.textContent='@keyframes typing{0%,60%,100%{opacity:0.3}30%{opacity:1}}';document.head.appendChild(style);
    </script>

</body>
</html>