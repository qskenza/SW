<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect - Medical Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f7f0 0%, #e8f5e8 100%);
            min-height: 100vh;
        }

        .main-header {
            background: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo { font-size: 1.8rem; font-weight: bold; color: #1b5e20; }

        .nav-links { display: flex; list-style: none; gap: 1.5rem; }

        .nav-links a {
            text-decoration: none;
            color: #388e3c;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-links a:hover, .nav-links a.active { background: #e8f5e8; color: #1b5e20; }

        .user-info { display: flex; align-items: center; gap: 1rem; }

        .user-avatar {
            width: 40px; height: 40px;
            background: #4caf50;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }

        .user-name { font-weight: 600; color: #1b5e20; }

        .logout-btn {
            background: #d32f2f; color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 5px;
            cursor: pointer; font-weight: 600;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .dashboard-title {
            text-align: center; font-size: 2.5rem; color: #1b5e20;
            margin-bottom: 0.5rem; font-weight: 700; font-style: italic;
        }

        .dashboard-subtitle { text-align: center; color: #666; font-size: 1.1rem; margin-bottom: 2rem; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }

        .card {
            background: white; border-radius: 15px;
            padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.3rem; color: #1b5e20; margin-bottom: 1rem;
            padding-bottom: 0.8rem; border-bottom: 2px solid #4caf50; font-weight: 600;
        }

        .student-card { background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); color: white; }
        .student-card .card-title { color: white; border-bottom-color: rgba(255,255,255,0.3); }

        .student-profile { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }

        .student-avatar {
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .student-name { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.3rem; }
        .student-id { opacity: 0.9; font-size: 0.95rem; }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label { opacity: 0.8; }
        .detail-value { font-weight: 600; }

        .medical-section { margin-bottom: 1.2rem; }
        .medical-section-title {
            font-size: 0.9rem; color: #2e7d32; font-weight: 600;
            margin-bottom: 0.5rem; text-transform: uppercase;
        }

        .medical-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0.8rem; background: #f8fff8;
            border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;
        }

        .medical-item-name { font-weight: 500; color: #333; }
        .medical-item-severity { font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; }
        .severity-severe { background: #ffebee; color: #c62828; }
        .severity-moderate { background: #fff3e0; color: #ef6c00; }
        .severity-mild { background: #e8f5e8; color: #2e7d32; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 2rem 1rem; text-align: center; min-height: 180px;
        }

        .empty-state-icon { width: 60px; height: 60px; margin-bottom: 1rem; opacity: 0.6; }
        .empty-state-icon svg { width: 100%; height: 100%; fill: #ccc; }
        .empty-state-title { color: #888; font-size: 1rem; font-weight: 500; margin-bottom: 0.3rem; }
        .empty-state-text { color: #aaa; font-size: 0.9rem; }

        .add-entry-btn {
            width: 100%; background: white; color: #1b5e20;
            border: 2px dashed #4caf50; padding: 0.8rem; border-radius: 8px;
            font-weight: 600; cursor: pointer; margin-top: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .add-entry-btn:hover { background: #e8f5e8; border-style: solid; }

        .view-all-btn {
            width: 100%; background: #2e7d32; color: white; border: none;
            padding: 0.8rem; border-radius: 8px; font-weight: 600;
            cursor: pointer; margin-top: 1rem;
        }
        .view-all-btn:hover { background: #1b5e20; }

        .visit-item {
            padding: 1rem; background: #f8fff8; border-radius: 10px;
            margin-bottom: 0.8rem; border-left: 4px solid #4caf50;
        }
        .visit-date { font-weight: 600; color: #1b5e20; margin-bottom: 0.3rem; }
        .visit-info { color: #666; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .visit-doctor { color: #888; font-size: 0.85rem; }

        .appointment-item {
            padding: 1rem; background: #f8fff8; border-radius: 10px;
            margin-bottom: 0.8rem; border-left: 4px solid #ff9800;
        }
        .appointment-date { font-weight: 600; color: #1b5e20; margin-bottom: 0.3rem; }
        .appointment-time { color: #ff9800; font-weight: 600; font-size: 0.95rem; }
        .appointment-doctor { color: #666; font-size: 0.9rem; margin-top: 0.3rem; }
        .appointment-type {
            display: inline-block; background: #e8f5e8; color: #2e7d32;
            padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; margin-top: 0.5rem;
        }

        .book-btn {
            width: 100%; background: #ff9800; color: white; border: none;
            padding: 0.8rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;
        }
        .book-btn:hover { background: #f57c00; }

        .loading-text { text-align: center; color: #888; padding: 1rem; font-style: italic; }

        .chat-button {
            position: fixed; bottom: 2rem; right: 2rem;
            width: 60px; height: 60px; background: #1b5e20;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3); border: none;
        }
        .chat-button:hover { transform: scale(1.1); }
        .chat-icon { color: white; font-size: 1.5rem; }

        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .nav-links { flex-wrap: wrap; justify-content: center; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo">CareConnect</div>
            <nav>
                <ul class="nav-links">
                    <li><a href="#" class="active">Dashboard</a></li>
                    <li><a href="AppointmentBooking.html">Appointments</a></li>
                    <li><a href="StudentProfile.html">Student Profile</a></li>
                    <li><a href="EmergencyRequest.html">Emergency</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <div class="user-avatar" id="headerAvatar">--</div>
                <span class="user-name" id="headerUserName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="dashboard-title">Medical Dashboard</h1>
        <p class="dashboard-subtitle">Your Complete Medical Records & Health Overview</p>

        <div class="dashboard-grid">
            <div class="card student-card">
                <h2 class="card-title">Student Information</h2>
                <div class="student-profile">
                    <div class="student-avatar" id="studentAvatar">--</div>
                    <div>
                        <div class="student-name" id="studentName">Loading...</div>
                        <div class="student-id" id="studentId">Student ID: ----</div>
                    </div>
                </div>
                <div class="student-details">
                    <div class="detail-row">
                        <span class="detail-label">Institution:</span>
                        <span class="detail-value">Al Akhawayn University</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value" id="studentDepartment">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Major:</span>
                        <span class="detail-value" id="studentMajor">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Academic Year:</span>
                        <span class="detail-value">2025/2026</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Medical Information</h2>
                <div id="medicalInfoContent"><p class="loading-text">Loading medical records...</p></div>
                <button class="add-entry-btn" onclick="window.location.href='AddMedicalEntry.html'">
                    <span>‚ûï</span> Add Medical Entry
                </button>
            </div>

            <div class="card">
                <h2 class="card-title">Recent Medical Visits</h2>
                <div id="visitsContainer"><p class="loading-text">Loading visits...</p></div>
                <button class="view-all-btn" onclick="window.location.href='VisitHistory.html'">View All Visit History</button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Upcoming Appointment</h2>
            <div id="appointmentsContainer"><p class="loading-text">Loading appointments...</p></div>
            <button class="book-btn" onclick="window.location.href='AppointmentBooking.html'">Book New Appointment</button>
        </div>

        <div class="dashboard-grid" style="margin-top: 2rem;">
            <div class="card">
                <h2 class="card-title">üíä My Prescriptions</h2>
                <div id="prescriptionsContainer"><p class="loading-text">Loading prescriptions...</p></div>
            </div>

            <div class="card">
                <h2 class="card-title">üìã My Referrals</h2>
                <div id="referralsContainer"><p class="loading-text">Loading referrals...</p></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';

        document.addEventListener('DOMContentLoaded', async function() {
            const token = sessionStorage.getItem('token');
            if (!token) { window.location.href = 'Login.html'; return; }
            if (sessionStorage.getItem('role') === 'doctor') { window.location.href = 'DoctorDashboard.html'; return; }

            await loadStudentProfile();
            await loadMedicalRecords();
            await loadVisitHistory();
            await loadUpcomingAppointments();
            await loadPrescriptions();
            await loadReferrals();
        });

        async function loadStudentProfile() {
            try {
                const response = await fetch(`${API_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) { if (response.status === 401) { sessionStorage.clear(); window.location.href = 'Login.html'; } return; }
                const data = await response.json();
                const initials = getInitials(data.full_name);
                document.getElementById('headerAvatar').textContent = initials;
                document.getElementById('headerUserName').textContent = data.full_name;
                document.getElementById('studentAvatar').textContent = initials;
                document.getElementById('studentName').textContent = data.full_name;
                document.getElementById('studentId').textContent = `Student ID: ${data.student_id || 'N/A'}`;
                document.getElementById('studentDepartment').textContent = data.department || 'Not specified';
                document.getElementById('studentMajor').textContent = data.major || 'Not specified';
            } catch (e) { console.error('Error:', e); }
        }

        async function loadMedicalRecords() {
            try {
                const response = await fetch(`${API_URL}/medical-records`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed');
                displayMedicalRecords(await response.json());
            } catch (e) { displayEmptyMedical(); }
        }

        function displayMedicalRecords(data) {
            const container = document.getElementById('medicalInfoContent');
            const has = (arr) => arr && arr.length > 0;
            if (!has(data.allergies) && !has(data.medications) && !has(data.conditions)) { displayEmptyMedical(); return; }
            
            let html = '';
            if (has(data.allergies)) {
                html += '<div class="medical-section"><div class="medical-section-title">Allergies</div>';
                data.allergies.forEach(a => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(a.name)}</span>${a.severity ? `<span class="medical-item-severity severity-${a.severity}">${esc(a.severity)}</span>` : ''}</div>`;
                });
                html += '</div>';
            }
            if (has(data.medications)) {
                html += '<div class="medical-section"><div class="medical-section-title">Medications</div>';
                data.medications.forEach(m => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(m.name)}</span></div>`;
                });
                html += '</div>';
            }
            if (has(data.conditions)) {
                html += '<div class="medical-section"><div class="medical-section-title">Conditions</div>';
                data.conditions.forEach(c => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(c.name)}</span>${c.severity ? `<span class="medical-item-severity severity-${c.severity}">${esc(c.severity)}</span>` : ''}</div>`;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function displayEmptyMedical() {
            document.getElementById('medicalInfoContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <p class="empty-state-title">No medical records</p>
                    <p class="empty-state-text">Add your medical information</p>
                </div>`;
        }

        async function loadVisitHistory() {
            try {
                const response = await fetch(`${API_URL}/visits/all`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (response.ok) { const data = await response.json(); displayVisits(data.visits || []); }
                else displayEmptyVisits();
            } catch (e) { displayEmptyVisits(); }
        }

        function displayVisits(visits) {
            if (!visits.length) { displayEmptyVisits(); return; }
            let html = '';
            visits.slice(0, 3).forEach(v => {
                html += `<div class="visit-item"><div class="visit-date">${formatDate(v.date)}</div><div class="visit-info">${esc(v.diagnosis || 'General Checkup')}</div><div class="visit-doctor">Dr. ${esc(v.doctor_name || 'Unknown')}</div></div>`;
            });
            document.getElementById('visitsContainer').innerHTML = html;
        }

        function displayEmptyVisits() {
            document.getElementById('visitsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <p class="empty-state-title">No recent medical visits</p>
                    <p class="empty-state-text">Your visit history will appear here</p>
                </div>`;
        }

        async function loadUpcomingAppointments() {
            try {
                const response = await fetch(`${API_URL}/appointments`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (response.ok) { const data = await response.json(); displayAppointments(Array.isArray(data) ? data : data.appointments || []); }
                else displayEmptyAppointments();
            } catch (e) { displayEmptyAppointments(); }
        }

        function displayAppointments(appointments) {
            const upcoming = appointments.filter(a => new Date(a.date || a.appointment_date) >= new Date() && a.status !== 'cancelled');
            if (!upcoming.length) { displayEmptyAppointments(); return; }
            let html = '';
            upcoming.slice(0, 2).forEach(a => {
                const canReschedule = a.can_reschedule !== false;
                html += `
                    <div class="appointment-item">
                        <div class="appointment-date">${formatDate(a.date || a.appointment_date)}</div>
                        <div class="appointment-time">${esc(a.time || a.appointment_time || 'TBD')}</div>
                        <div class="appointment-doctor">Dr. ${esc(a.doctor_name || 'Unknown')}</div>
                        <span class="appointment-type">${esc(a.type || 'General')}</span>
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            ${canReschedule ? `<button onclick="rescheduleAppointment(${a.id})" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Reschedule</button>` : ''}
                            <button onclick="cancelAppointment(${a.id})" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Cancel</button>
                        </div>
                    </div>`;
            });
            document.getElementById('appointmentsContainer').innerHTML = html;
        }

        function displayEmptyAppointments() {
            document.getElementById('appointmentsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg></div>
                    <p class="empty-state-title">No upcoming appointments</p>
                    <p class="empty-state-text">Book an appointment to get started</p>
                </div>`;
        }

        function getInitials(name) { if (!name) return '--'; const n = name.trim().split(' '); return n.length >= 2 ? (n[0][0] + n[n.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase(); }
        function formatDate(d) { if (!d) return 'N/A'; return new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }); }
        function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function logout() { sessionStorage.clear(); window.location.href = 'Login.html'; }

        async function rescheduleAppointment(appointmentId) {
            try {
                // First, get appointment details to check 12-hour rule
                const response = await fetch(`${API_URL}/appointments`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });

                if (!response.ok) {
                    alert('‚ùå Failed to load appointment details');
                    return;
                }

                const appointments = await response.json();
                const appointment = appointments.find(a => a.id === appointmentId);

                if (!appointment) {
                    alert('‚ùå Appointment not found');
                    return;
                }

                // Check if can reschedule (12-hour rule)
                if (!appointment.can_reschedule) {
                    alert(`‚ö†Ô∏è Cannot Reschedule\n\nYou can only reschedule appointments that are more than 12 hours away.\n\nThis appointment is scheduled for:\n${appointment.date} at ${appointment.time}\n\nPlease contact the health center directly for urgent changes:\nüìû Phone: 0535-86-0104`);
                    return;
                }

                // Show reschedule dialog
                const newDate = prompt(`Reschedule Appointment\n\nCurrent appointment:\n${appointment.date} at ${appointment.time}\nDoctor: ${appointment.doctor_name}\n\nEnter new date (YYYY-MM-DD):`);

                if (!newDate) return; // User cancelled

                const newTime = prompt(`Enter new time (HH:MM AM/PM):\n\nExample: 10:00 AM`);

                if (!newTime) return; // User cancelled

                // Update appointment
                const updateResponse = await fetch(`${API_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appointment_date: newDate,
                        appointment_time: newTime
                    })
                });

                if (updateResponse.ok) {
                    alert(`‚úÖ Appointment Rescheduled!\n\nNew date: ${newDate}\nNew time: ${newTime}\n\nYou will receive a confirmation email.`);
                    location.reload(); // Refresh to show updated appointment
                } else {
                    const error = await updateResponse.json();
                    alert(`‚ùå Failed to reschedule: ${error.detail || 'Unknown error'}`);
                }

            } catch (error) {
                console.error('Error rescheduling appointment:', error);
                alert('‚ùå Network error. Please try again.');
            }
        }

        async function cancelAppointment(appointmentId) {
            const confirmCancel = confirm('Are you sure you want to cancel this appointment?\n\nThis action cannot be undone.');

            if (!confirmCancel) return;

            try {
                const response = await fetch(`${API_URL}/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });

                if (response.ok) {
                    alert('‚úÖ Appointment cancelled successfully');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Failed to cancel: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
                alert('‚ùå Network error. Please try again.');
            }
        }

        async function loadPrescriptions() {
            try {
                const response = await fetch(`${API_URL}/my-prescriptions`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed');
                const prescriptions = await response.json();
                displayPrescriptions(prescriptions);
            } catch (e) {
                document.getElementById('prescriptionsContainer').innerHTML = '<p class="empty-state">No prescriptions found</p>';
            }
        }

        function displayPrescriptions(prescriptions) {
            const container = document.getElementById('prescriptionsContainer');
            if (!prescriptions || prescriptions.length === 0) {
                container.innerHTML = '<p class="empty-state">No prescriptions found</p>';
                return;
            }

            let html = '';
            prescriptions.forEach(presc => {
                const date = presc.created_at ? new Date(presc.created_at).toLocaleDateString() : 'N/A';
                const statusClass = presc.status === 'active' ? 'active' : 'completed';
                const statusBadge = presc.status === 'active' ? 'üü¢ Active' : '‚ö™ Completed';

                html += `
                    <div class="entry-item" style="margin-bottom: 1rem; padding: 1rem; background: #f8fff8; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <strong style="color: #2e7d32; font-size: 1.1rem;">${presc.medication}</strong>
                            <span style="font-size: 0.85rem; color: ${presc.status === 'active' ? '#4caf50' : '#999'};">${statusBadge}</span>
                        </div>
                        <div style="color: #666; margin-bottom: 0.3rem;"><strong>Dosage:</strong> ${presc.dosage}</div>
                        <div style="color: #666; margin-bottom: 0.3rem;"><strong>Frequency:</strong> ${presc.frequency}</div>
                        <div style="color: #666; margin-bottom: 0.3rem;"><strong>Duration:</strong> ${presc.duration}</div>
                        ${presc.instructions ? `<div style="color: #666; margin-bottom: 0.3rem;"><strong>Instructions:</strong> ${presc.instructions}</div>` : ''}
                        <div style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">
                            Prescribed by <strong>${presc.doctor_name}</strong> on ${date}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function loadReferrals() {
            try {
                const response = await fetch(`${API_URL}/my-referrals`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed');
                const referrals = await response.json();
                displayReferrals(referrals);
            } catch (e) {
                document.getElementById('referralsContainer').innerHTML = '<p class="empty-state">No referrals found</p>';
            }
        }

        function displayReferrals(referrals) {
            const container = document.getElementById('referralsContainer');
            if (!referrals || referrals.length === 0) {
                container.innerHTML = '<p class="empty-state">No referrals found</p>';
                return;
            }

            let html = '';
            referrals.forEach(ref => {
                const date = ref.created_at ? new Date(ref.created_at).toLocaleDateString() : 'N/A';
                const priorityColors = {
                    'routine': '#4caf50',
                    'urgent': '#ff9800',
                    'emergency': '#d32f2f'
                };
                const priorityColor = priorityColors[ref.priority] || '#4caf50';
                const statusBadge = ref.status === 'pending' ? 'üü° Pending' : ref.status === 'scheduled' ? 'üîµ Scheduled' : 'üü¢ Completed';

                html += `
                    <div class="entry-item" style="margin-bottom: 1rem; padding: 1rem; background: #f8fff8; border-radius: 8px; border-left: 4px solid ${priorityColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <strong style="color: #2e7d32; font-size: 1.1rem;">${ref.specialist_type}</strong>
                            <span style="font-size: 0.85rem; color: #666;">${statusBadge}</span>
                        </div>
                        <div style="color: #666; margin-bottom: 0.3rem;"><strong>Reason:</strong> ${ref.reason}</div>
                        <div style="color: #666; margin-bottom: 0.3rem;"><strong>Priority:</strong> <span style="color: ${priorityColor}; font-weight: 600; text-transform: uppercase;">${ref.priority}</span></div>
                        ${ref.notes ? `<div style="color: #666; margin-bottom: 0.3rem;"><strong>Notes:</strong> ${ref.notes}</div>` : ''}
                        <div style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">
                            Referred by <strong>${ref.doctor_name}</strong> on ${date}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
    </script>

    <!-- CHATBOT -->
    <style>
        #chatbot-widget{position:fixed;bottom:20px;right:20px;z-index:1000;font-family:'Segoe UI',Arial,sans-serif}#chat-button{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#2e7d32 0%,#4caf50 100%);border:none;cursor:pointer;box-shadow:0 4px 20px rgba(46,125,50,0.4);display:flex;align-items:center;justify-content:center;transition:all .3s ease}#chat-button:hover{transform:scale(1.1)}#chat-button svg{width:30px;height:30px;fill:white}#chat-window{display:none;position:fixed;bottom:90px;right:20px;width:380px;height:550px;background:white;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.2);flex-direction:column;overflow:hidden}#chat-window.open{display:flex}.chat-header{background:linear-gradient(135deg,#2e7d32 0%,#4caf50 100%);color:white;padding:20px;display:flex;justify-content:space-between;align-items:center}.chat-header h3{margin:0;font-size:1.3rem}.chat-header p{margin:5px 0 0 0;opacity:0.9;font-size:0.9rem}#close-chat{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer}#chat-messages{flex:1;overflow-y:auto;padding:20px;background:#f8fff8}.message{margin-bottom:15px;display:flex;flex-direction:column}.message.user{align-items:flex-end}.message.bot{align-items:flex-start}.message-content{max-width:80%;padding:12px 16px;border-radius:12px;word-wrap:break-word}.message.user .message-content{background:#2e7d32;color:white}.message.bot .message-content{background:white;color:#333;border:1px solid #e8f5e8}.message-time{font-size:0.75rem;color:#999;margin-top:5px}.chat-input-container{padding:15px;background:white;border-top:1px solid #e8f5e8;display:flex;gap:10px}#chat-input{flex:1;padding:12px 15px;border:2px solid #e8f5e8;border-radius:25px;font-size:0.95rem;outline:none}#chat-input:focus{border-color:#4caf50}#send-button{background:#4caf50;color:white;border:none;width:45px;height:45px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}#send-button:hover{background:#388e3c}.quick-actions{padding:10px 20px;background:white;border-top:1px solid #e8f5e8;display:flex;gap:8px;flex-wrap:wrap}.quick-action-btn{padding:8px 12px;background:#e8f5e8;color:#2e7d32;border:none;border-radius:15px;font-size:0.85rem;cursor:pointer}.quick-action-btn:hover{background:#4caf50;color:white}
    </style>

    <div id="chatbot-widget">
        <button id="chat-button"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg></button>
        <div id="chat-window">
            <div class="chat-header"><div><h3>CareConnect Assistant</h3><p>Ask me anything</p></div><button id="close-chat">√ó</button></div>
            <div class="quick-actions">
                <button class="quick-action-btn" data-msg="Book an appointment">üìÖ Appointment</button>
                <button class="quick-action-btn" data-msg="I need emergency help">üö® Emergency</button>
            </div>
            <div id="chat-messages">
                <div class="message bot"><div class="message-content">Hello! How can I help you today?</div></div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type your message..." />
                <button id="send-button"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
    let conversationId=null,userContext=null;const chatButton=document.getElementById('chat-button'),chatWindow=document.getElementById('chat-window'),closeChat=document.getElementById('close-chat'),chatMessages=document.getElementById('chat-messages'),chatInput=document.getElementById('chat-input'),sendButton=document.getElementById('send-button');chatButton.addEventListener('click',()=>{chatWindow.classList.toggle('open');chatWindow.classList.contains('open')&&chatInput.focus()});closeChat.addEventListener('click',()=>chatWindow.classList.remove('open'));async function sendMessage(msg){if(!msg.trim())return;addMessage(msg,'user');chatInput.value='';sendButton.disabled=true;showTypingIndicator();try{const res=await fetch(`${API_URL}/chat/`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,conversation_id:conversationId,user_context:userContext})});const data=await res.json();hideTypingIndicator();conversationId=data.conversation_id;addMessage(data.reply,'bot')}catch(e){hideTypingIndicator();addMessage('Sorry, error occurred.','bot');console.error(e)}finally{sendButton.disabled=false}}function addMessage(text,type){const msgDiv=document.createElement('div');msgDiv.className=`message ${type}`;const contentDiv=document.createElement('div');contentDiv.className='message-content';contentDiv.textContent=text;const timeDiv=document.createElement('div');timeDiv.className='message-time';timeDiv.textContent=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});msgDiv.appendChild(contentDiv);msgDiv.appendChild(timeDiv);chatMessages.appendChild(msgDiv);chatMessages.scrollTop=chatMessages.scrollHeight}function showTypingIndicator(){const indicator=document.createElement('div');indicator.className='message bot';indicator.id='typing-indicator';indicator.innerHTML='<div style="padding:12px;background:white;border:1px solid #e8f5e8;border-radius:12px"><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;margin-right:4px;animation:typing 1.4s infinite"></span><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;margin-right:4px;animation:typing 1.4s infinite 0.2s"></span><span style="height:8px;width:8px;background:#4caf50;border-radius:50%;display:inline-block;animation:typing 1.4s infinite 0.4s"></span></div>';chatMessages.appendChild(indicator);chatMessages.scrollTop=chatMessages.scrollHeight}function hideTypingIndicator(){const indicator=document.getElementById('typing-indicator');indicator&&indicator.remove()}sendButton.addEventListener('click',()=>sendMessage(chatInput.value));chatInput.addEventListener('keypress',e=>{e.key==='Enter'&&sendMessage(chatInput.value)});document.querySelectorAll('.quick-action-btn').forEach(btn=>btn.addEventListener('click',()=>sendMessage(btn.dataset.msg)));function loadUserContext(){const username=sessionStorage.getItem('username'),fullName=sessionStorage.getItem('fullName'),studentId=sessionStorage.getItem('studentId');username&&(userContext={name:fullName||username,student_id:studentId||'N/A'})}loadUserContext();const style=document.createElement('style');style.textContent='@keyframes typing{0%,60%,100%{opacity:0.3}30%{opacity:1}}';document.head.appendChild(style);
    </script>
</body>
</html>