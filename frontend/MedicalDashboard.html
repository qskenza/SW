<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareConnect - Medical Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f7f0 0%, #e8f5e8 100%);
            min-height: 100vh;
        }

        .main-header {
            background: white;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo { font-size: 1.8rem; font-weight: bold; color: #1b5e20; }

        .nav-links { display: flex; list-style: none; gap: 1.5rem; }

        .nav-links a {
            text-decoration: none;
            color: #388e3c;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-links a:hover, .nav-links a.active { background: #e8f5e8; color: #1b5e20; }

        .user-info { display: flex; align-items: center; gap: 1rem; }

        .user-avatar {
            width: 40px; height: 40px;
            background: #4caf50;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }

        .user-name { font-weight: 600; color: #1b5e20; }

        .logout-btn {
            background: #d32f2f; color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 5px;
            cursor: pointer; font-weight: 600;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .dashboard-title {
            text-align: center; font-size: 2.5rem; color: #1b5e20;
            margin-bottom: 0.5rem; font-weight: 700; font-style: italic;
        }

        .dashboard-subtitle { text-align: center; color: #666; font-size: 1.1rem; margin-bottom: 2rem; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }

        .card {
            background: white; border-radius: 15px;
            padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 1.3rem; color: #1b5e20; margin-bottom: 1rem;
            padding-bottom: 0.8rem; border-bottom: 2px solid #4caf50; font-weight: 600;
        }

        .student-card { background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); color: white; }
        .student-card .card-title { color: white; border-bottom-color: rgba(255,255,255,0.3); }

        .student-profile { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }

        .student-avatar {
            width: 70px; height: 70px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; font-weight: bold;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .student-name { font-size: 1.4rem; font-weight: 600; margin-bottom: 0.3rem; }
        .student-id { opacity: 0.9; font-size: 0.95rem; }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .detail-label { opacity: 0.8; }
        .detail-value { font-weight: 600; }

        .medical-section { margin-bottom: 1.2rem; }
        .medical-section-title {
            font-size: 0.9rem; color: #2e7d32; font-weight: 600;
            margin-bottom: 0.5rem; text-transform: uppercase;
        }

        .medical-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0.8rem; background: #f8fff8;
            border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid #4caf50;
        }

        .medical-item-name { font-weight: 500; color: #333; }
        .medical-item-severity { font-size: 0.8rem; padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; }
        .severity-severe { background: #ffebee; color: #c62828; }
        .severity-moderate { background: #fff3e0; color: #ef6c00; }
        .severity-mild { background: #e8f5e8; color: #2e7d32; }

        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 2rem 1rem; text-align: center; min-height: 180px;
        }

        .empty-state-icon { width: 60px; height: 60px; margin-bottom: 1rem; opacity: 0.6; }
        .empty-state-icon svg { width: 100%; height: 100%; fill: #ccc; }
        .empty-state-title { color: #888; font-size: 1rem; font-weight: 500; margin-bottom: 0.3rem; }
        .empty-state-text { color: #aaa; font-size: 0.9rem; }

        .add-entry-btn {
            width: 100%; background: white; color: #1b5e20;
            border: 2px dashed #4caf50; padding: 0.8rem; border-radius: 8px;
            font-weight: 600; cursor: pointer; margin-top: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .add-entry-btn:hover { background: #e8f5e8; border-style: solid; }

        .view-all-btn {
            width: 100%; background: #2e7d32; color: white; border: none;
            padding: 0.8rem; border-radius: 8px; font-weight: 600;
            cursor: pointer; margin-top: 1rem;
        }
        .view-all-btn:hover { background: #1b5e20; }

        .visit-item {
            padding: 1rem; background: #f8fff8; border-radius: 10px;
            margin-bottom: 0.8rem; border-left: 4px solid #4caf50;
        }
        .visit-date { font-weight: 600; color: #1b5e20; margin-bottom: 0.3rem; }
        .visit-info { color: #666; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .visit-doctor { color: #888; font-size: 0.85rem; }

        .appointment-item {
            padding: 1rem; background: #f8fff8; border-radius: 10px;
            margin-bottom: 0.8rem; border-left: 4px solid #ff9800;
        }
        .appointment-date { font-weight: 600; color: #1b5e20; margin-bottom: 0.3rem; }
        .appointment-time { color: #ff9800; font-weight: 600; font-size: 0.95rem; }
        .appointment-doctor { color: #666; font-size: 0.9rem; margin-top: 0.3rem; }
        .appointment-type {
            display: inline-block; background: #e8f5e8; color: #2e7d32;
            padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; margin-top: 0.5rem;
        }

        .book-btn {
            width: 100%; background: #ff9800; color: white; border: none;
            padding: 0.8rem; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;
        }
        .book-btn:hover { background: #f57c00; }

        .loading-text { text-align: center; color: #888; padding: 1rem; font-style: italic; }

        .chat-button {
            position: fixed; bottom: 2rem; right: 2rem;
            width: 60px; height: 60px; background: #1b5e20;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 15px rgba(27, 94, 32, 0.3); border: none;
        }
        .chat-button:hover { transform: scale(1.1); }
        .chat-icon { color: white; font-size: 1.5rem; }

        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .nav-links { flex-wrap: wrap; justify-content: center; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo">CareConnect</div>
            <nav>
                <ul class="nav-links">
                    <li><a href="#" class="active">Dashboard</a></li>
                    <li><a href="AppointmentBooking.html">Appointments</a></li>
                    <li><a href="StudentProfile.html">Student Profile</a></li>
                    <li><a href="EmergencyRequest.html">Emergency</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <div class="user-avatar" id="headerAvatar">--</div>
                <span class="user-name" id="headerUserName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <h1 class="dashboard-title">Medical Dashboard</h1>
        <p class="dashboard-subtitle">Your Complete Medical Records & Health Overview</p>

        <div class="dashboard-grid">
            <div class="card student-card">
                <h2 class="card-title">Student Information</h2>
                <div class="student-profile">
                    <div class="student-avatar" id="studentAvatar">--</div>
                    <div>
                        <div class="student-name" id="studentName">Loading...</div>
                        <div class="student-id" id="studentId">Student ID: ----</div>
                    </div>
                </div>
                <div class="student-details">
                    <div class="detail-row">
                        <span class="detail-label">Institution:</span>
                        <span class="detail-value">Al Akhawayn University</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value" id="studentDepartment">---</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Major:</span>
                        <span class="detail-value" id="studentMajor">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Academic Year:</span>
                        <span class="detail-value">2025/2026</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Medical Information</h2>
                <div id="medicalInfoContent"><p class="loading-text">Loading medical records...</p></div>
                <button class="add-entry-btn" onclick="window.location.href='AddMedicalEntry.html'">
                    <span>âž•</span> Add Medical Entry
                </button>
            </div>

            <div class="card">
                <h2 class="card-title">Recent Medical Visits</h2>
                <div id="visitsContainer"><p class="loading-text">Loading visits...</p></div>
                <button class="view-all-btn" onclick="window.location.href='VisitHistory.html'">View All Visit History</button>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Upcoming Appointment</h2>
            <div id="appointmentsContainer"><p class="loading-text">Loading appointments...</p></div>
            <button class="book-btn" onclick="window.location.href='AppointmentBooking.html'">Book New Appointment</button>
        </div>
    </div>

    <button class="chat-button" onclick="openChat()"><span class="chat-icon">ðŸ’¬</span></button>

    <script>
        const API_URL = 'http://localhost:8000';

        document.addEventListener('DOMContentLoaded', async function() {
            const token = sessionStorage.getItem('token');
            if (!token) { window.location.href = 'Login.html'; return; }
            if (sessionStorage.getItem('role') === 'doctor') { window.location.href = 'DoctorDashboard.html'; return; }
            
            await loadStudentProfile();
            await loadMedicalRecords();
            await loadVisitHistory();
            await loadUpcomingAppointments();
        });

        async function loadStudentProfile() {
            try {
                const response = await fetch(`${API_URL}/profile`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) { if (response.status === 401) { sessionStorage.clear(); window.location.href = 'Login.html'; } return; }
                const data = await response.json();
                const initials = getInitials(data.full_name);
                document.getElementById('headerAvatar').textContent = initials;
                document.getElementById('headerUserName').textContent = data.full_name;
                document.getElementById('studentAvatar').textContent = initials;
                document.getElementById('studentName').textContent = data.full_name;
                document.getElementById('studentId').textContent = `Student ID: ${data.student_id || 'N/A'}`;
                document.getElementById('studentDepartment').textContent = data.department || 'Not specified';
                document.getElementById('studentMajor').textContent = data.major || 'Not specified';
            } catch (e) { console.error('Error:', e); }
        }

        async function loadMedicalRecords() {
            try {
                const response = await fetch(`${API_URL}/medical-records`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed');
                displayMedicalRecords(await response.json());
            } catch (e) { displayEmptyMedical(); }
        }

        function displayMedicalRecords(data) {
            const container = document.getElementById('medicalInfoContent');
            const has = (arr) => arr && arr.length > 0;
            if (!has(data.allergies) && !has(data.medications) && !has(data.conditions)) { displayEmptyMedical(); return; }
            
            let html = '';
            if (has(data.allergies)) {
                html += '<div class="medical-section"><div class="medical-section-title">Allergies</div>';
                data.allergies.forEach(a => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(a.name)}</span>${a.severity ? `<span class="medical-item-severity severity-${a.severity}">${esc(a.severity)}</span>` : ''}</div>`;
                });
                html += '</div>';
            }
            if (has(data.medications)) {
                html += '<div class="medical-section"><div class="medical-section-title">Medications</div>';
                data.medications.forEach(m => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(m.name)}</span></div>`;
                });
                html += '</div>';
            }
            if (has(data.conditions)) {
                html += '<div class="medical-section"><div class="medical-section-title">Conditions</div>';
                data.conditions.forEach(c => {
                    html += `<div class="medical-item"><span class="medical-item-name">${esc(c.name)}</span>${c.severity ? `<span class="medical-item-severity severity-${c.severity}">${esc(c.severity)}</span>` : ''}</div>`;
                });
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function displayEmptyMedical() {
            document.getElementById('medicalInfoContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <p class="empty-state-title">No medical records</p>
                    <p class="empty-state-text">Add your medical information</p>
                </div>`;
        }

        async function loadVisitHistory() {
            try {
                const response = await fetch(`${API_URL}/visits/all`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (response.ok) { const data = await response.json(); displayVisits(data.visits || []); }
                else displayEmptyVisits();
            } catch (e) { displayEmptyVisits(); }
        }

        function displayVisits(visits) {
            if (!visits.length) { displayEmptyVisits(); return; }
            let html = '';
            visits.slice(0, 3).forEach(v => {
                html += `<div class="visit-item"><div class="visit-date">${formatDate(v.date)}</div><div class="visit-info">${esc(v.diagnosis || 'General Checkup')}</div><div class="visit-doctor">Dr. ${esc(v.doctor_name || 'Unknown')}</div></div>`;
            });
            document.getElementById('visitsContainer').innerHTML = html;
        }

        function displayEmptyVisits() {
            document.getElementById('visitsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <p class="empty-state-title">No recent medical visits</p>
                    <p class="empty-state-text">Your visit history will appear here</p>
                </div>`;
        }

        async function loadUpcomingAppointments() {
            try {
                const response = await fetch(`${API_URL}/appointments`, {
                    headers: { 'Authorization': `Bearer ${sessionStorage.getItem('token')}` }
                });
                if (response.ok) { const data = await response.json(); displayAppointments(Array.isArray(data) ? data : data.appointments || []); }
                else displayEmptyAppointments();
            } catch (e) { displayEmptyAppointments(); }
        }

        function displayAppointments(appointments) {
            const upcoming = appointments.filter(a => new Date(a.date || a.appointment_date) >= new Date() && a.status !== 'cancelled');
            if (!upcoming.length) { displayEmptyAppointments(); return; }
            let html = '';
            upcoming.slice(0, 2).forEach(a => {
                html += `<div class="appointment-item"><div class="appointment-date">${formatDate(a.date || a.appointment_date)}</div><div class="appointment-time">${esc(a.time || a.appointment_time || 'TBD')}</div><div class="appointment-doctor">Dr. ${esc(a.doctor_name || 'Unknown')}</div><span class="appointment-type">${esc(a.type || 'General')}</span></div>`;
            });
            document.getElementById('appointmentsContainer').innerHTML = html;
        }

        function displayEmptyAppointments() {
            document.getElementById('appointmentsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg></div>
                    <p class="empty-state-title">No upcoming appointments</p>
                    <p class="empty-state-text">Book an appointment to get started</p>
                </div>`;
        }

        function getInitials(name) { if (!name) return '--'; const n = name.trim().split(' '); return n.length >= 2 ? (n[0][0] + n[n.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase(); }
        function formatDate(d) { if (!d) return 'N/A'; return new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }); }
        function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function logout() { sessionStorage.clear(); window.location.href = 'Login.html'; }
        function openChat() { alert('Chat support coming soon!'); }
    </script>
</body>
</html>